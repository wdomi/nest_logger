<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Nest Logger</title>

  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="apple-touch-icon" href="/favicon.png">

  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body{
      margin:0;
      padding:12px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:#f8f8f8;
    }
    header{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    header img{ width:45px;height:45px; }
    h1{ margin:0;font-size:22px; }
    .subtitle{ font-size:13px;color:#666; }

    .card{
      background:#fff;
      border-radius:12px;
      padding:10px;
      margin-bottom:10px;
      box-shadow:0 1px 4px rgba(0,0,0,.08);
    }
    label{ font-size:14px;font-weight:500;display:block;margin-bottom:4px; }
    input, select, textarea{
      width:100%;
      padding:7px 9px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
    }
    textarea{ min-height:60px; resize:vertical; }

    .field{ margin-bottom:8px; }

    .map-wrapper{
      height:260px;
      border-radius:10px;
      overflow:hidden;
    }
    #map{ width:100%; height:100%; }

    .btn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #bbb;
      background:#eee;
      cursor:pointer;
      font-size:14px;
    }
    .btn-primary{
      background:#2a4d69;
      color:#fff;
      border-color:#2a4d69;
    }

    .status{ font-size:13px;margin-top:4px; }
    .status.success{ color:#2a7b3f; }
    .status.error{ color:#c22; }

    #offlineStatus{
      font-size:13px;
      color:#666;
      margin-bottom:8px;
      display:none;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.85);
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      display:none;
      z-index:9999;
    }
    .toast.show{ display:block; }

    @media (min-width:700px){
      body{ max-width:480px;margin:auto; }
    }
  </style>
</head>

<body>

<header>
  <img src="/favicon.png" alt="">
  <div style="flex:1">
    <h1>Nest Logger</h1>
    <div class="subtitle">Log dipper nests with GPS, status and photos.</div>
  </div>
  <a href="https://dipper-finder.vercel.app"
     style="padding:6px 12px;border-radius:999px;background:#2a4d69;color:#fff;text-decoration:none;font-size:13px;">
     Dipper-Finder
  </a>
</header>

<div id="offlineStatus"></div>

<!-- FORM -->
<div class="card">
  <div class="field">
    <label>River</label>
    <input id="river" type="text">
  </div>
  <div class="field">
    <label>Nest name *</label>
    <input id="nestName" type="text">
  </div>
  <div class="field">
    <label>Nest ID</label>
    <input id="nestId" type="text">
  </div>
  <div class="field">
    <label>Status *</label>
    <label><input type="radio" name="status" value="maintained" checked> Maintained</label>
    <label><input type="radio" name="status" value="old"> Old</label>
    <label><input type="radio" name="status" value="broken"> Broken</label>
  </div>
  <div class="field">
    <label>Territory</label>
    <input id="territory" type="text">
  </div>
</div>

<!-- MAP -->
<div class="card">
  <button id="locBtn" class="btn">Use my location</button>
  <div class="map-wrapper">
    <div id="map"></div>
  </div>
  Lat: <span id="latDisplay">–</span>,
  Lon: <span id="lonDisplay">–</span>
</div>

<!-- PHOTOS -->
<div class="card">
  <label>Photos</label>
  <input id="img1" type="file" accept="image/*">
  <input id="img2" type="file" accept="image/*">
</div>

<!-- EXTRA -->
<div class="card">
  <label>Remark</label>
  <textarea id="remark"></textarea>

  <label>Ladder</label>
  <label><input type="radio" name="ladder" value="y"> Yes</label>
  <label><input type="radio" name="ladder" value="n"> No</label>
  <label><input type="radio" name="ladder" value="maybe" checked> Maybe</label>

  <label>Height (m)</label>
  <input id="height_m" type="number" step="0.1">

  <label>Side going downriver</label>
  <select id="side">
    <option value="">–</option>
    <option>right</option>
    <option>left</option>
    <option>middle</option>
    <option>roof</option>
  </select>

  <label>Aspect</label>
  <select id="aspect">
    <option value="">–</option>
    <option>N</option><option>NE</option><option>E</option><option>SE</option>
    <option>S</option><option>SW</option><option>W</option><option>NW</option>
  </select>
</div>

<div class="card">
  <button id="saveBtn" class="btn btn-primary" style="width:100%">Save nest</button>
  <div id="status" class="status"></div>
</div>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js").catch(console.error);
}

let map, marker;
const latDisplay = document.getElementById("latDisplay");
const lonDisplay = document.getElementById("lonDisplay");

function setCoords(lat, lon){
  latDisplay.textContent = lat.toFixed(6);
  lonDisplay.textContent = lon.toFixed(6);
  marker.setLatLng([lat, lon]);
  map.setView([lat, lon], 15);
}

document.addEventListener("DOMContentLoaded", () => {
  map = L.map("map").setView([46.629554, 10.194787], 9);

  L.tileLayer(
    "https://api.maptiler.com/maps/topo-v4/{z}/{x}/{y}.png?key=hTUZRiAhto38o94bZonV",
    { maxZoom:20, tileSize:512, zoomOffset:-1 }
  ).addTo(map);

  marker = L.marker([46.629554, 10.194787], { draggable:true }).addTo(map);
  marker.on("moveend", e=>{
    const p=e.target.getLatLng();
    setCoords(p.lat,p.lng);
  });

  setCoords(46.629554,10.194787);

  document.getElementById("locBtn").onclick = useMyLocation;
  document.getElementById("saveBtn").onclick = onSave;

  updateOfflineStatus();
  tryFlushQueue();
});

function useMyLocation(){
  navigator.geolocation.getCurrentPosition(
    p=>setCoords(p.coords.latitude,p.coords.longitude),
    ()=>showToast("Location failed"),
    {enableHighAccuracy:true}
  );
}

// ---------------- OFFLINE QUEUE ----------------
const OFFLINE_KEY="nestlogger_queue";

function getQueue(){
  try{return JSON.parse(localStorage.getItem(OFFLINE_KEY)||"[]");}
  catch{return[];}
}
function setQueue(q){
  localStorage.setItem(OFFLINE_KEY,JSON.stringify(q));
}
function updateOfflineStatus(){
  const q=getQueue();
  const el=document.getElementById("offlineStatus");
  if(!q.length){ el.style.display="none"; return; }
  el.style.display="block";
  el.textContent = `${q.length} Nest(s) locally stored – will upload when online.`;
}

async function saveNestOnline(payload){
  const r=await fetch("/api/nest-submit",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });
  if(!r.ok) throw new Error();
}

async function tryFlushQueue(){
  if(!navigator.onLine) return;
  const q=getQueue(), remaining=[];
  for(const e of q){
    try{ await saveNestOnline(e); }
    catch{ remaining.push(e); }
  }
  setQueue(remaining);
  updateOfflineStatus();
}

// ---------------- UI ----------------
function showToast(msg,ms=2500){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),ms);
}
function setStatus(msg,type=""){
  const el=document.getElementById("status");
  el.textContent=msg;
  el.className="status "+type;
}

// ⭐ RESET FORM
function resetFormForNextObservation(){
  // text + number fields EXCEPT river
  document.querySelectorAll("input[type=text], input[type=number], textarea")
    .forEach(el => {
      if (el.id !== "river") {
        el.value = "";
      }
    });

  // selects
  document.querySelectorAll("select").forEach(el => el.value = "");

  // radios → restore defaults
  document.querySelector('input[name="status"][value="maintained"]').checked = true;
  document.querySelector('input[name="ladder"][value="maybe"]').checked = true;

  // file inputs
  document.getElementById("img1").value = "";
  document.getElementById("img2").value = "";

  // clear save status text
  setStatus("");
}


// ---------------- SAVE ----------------
function getSelectedStatus(){
  return document.querySelector('input[name="status"]:checked').value;
}

async function onSave(){
  const nest_name=document.getElementById("nestName").value.trim();
  if(!nest_name){
    setStatus("Nest name required","error");
    showToast("Nest name required");
    return;
  }

  const payload={
    river:document.getElementById("river").value||null,
    nest_name,
    nest_id:document.getElementById("nestId").value||null,
    status:getSelectedStatus(),
    latitude:Number(latDisplay.textContent),
    longitude:Number(lonDisplay.textContent),
    territory:document.getElementById("territory").value||null,
    remark:document.getElementById("remark").value||null,
    ladder:document.querySelector('input[name="ladder"]:checked')?.value||null,
    height_m:Number(document.getElementById("height_m").value)||null,
    side_going_downriver:document.getElementById("side").value||null,
    aspect:document.getElementById("aspect").value||null,
    images:[]
  };

  if(!navigator.onLine){
    const q=getQueue();
    q.push(payload);
    setQueue(q);
    updateOfflineStatus();
    showToast("Nest stored offline");
    resetFormForNextObservation();
    return;
  }

  try{
    await saveNestOnline(payload);
    showToast("Nest saved");
    resetFormForNextObservation();
    tryFlushQueue();
  }catch{
    const q=getQueue();
    q.push(payload);
    setQueue(q);
    updateOfflineStatus();
    showToast("Nest stored offline");
    resetFormForNextObservation();
  }
}
</script>
</body>
</html>
